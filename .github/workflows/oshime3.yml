name: swing-metrics

on:
  schedule:
    - cron: "0 23 * * *"   # JST 8:00（UTC 23:00）

  workflow_dispatch:
    inputs:
      force:
        description: "Force run even if market is closed"
        type: boolean
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  run_market_regime:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Set up job
        run: |
          echo "job start: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Check envs
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JQUANTS_API_KEY: ${{ secrets.JQUANTS_API_KEY }}
        run: |
          mkdir -p logs reports charts
          echo "DISCORD_WEBHOOK_URL set? $([[ -n \"$DISCORD_WEBHOOK_URL\" ]] && echo yes || echo no)" | tee logs/00_env_check.log
          echo "OPENAI_API_KEY set? $([[ -n \"$OPENAI_API_KEY\" ]] && echo yes || echo no)" | tee -a logs/00_env_check.log
          echo "JQUANTS_API_KEY set? $([[ -n \"$JQUANTS_API_KEY\" ]] && echo yes || echo no)" | tee -a logs/00_env_check.log

      - name: Run scripts (write logs to files)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JQUANTS_API_KEY: ${{ secrets.JQUANTS_API_KEY }}
          FORCE_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.force == 'true' && '1' || '' }}
          ENABLE_AI: "1"
          AI_ONLY_ON_ALERT: ${{ github.event_name == 'workflow_dispatch' && '0' || '1' }}
        run: |
          mkdir -p logs reports charts

          echo "=== main_rsi.py ===" | tee logs/10_main_rsi.log
          python main_rsi.py 2>&1 | tee -a logs/10_main_rsi.log

          echo "=== ADX_DI.py ===" | tee logs/20_ADX_DI.log
          python ADX_DI.py 2>&1 | tee -a logs/20_ADX_DI.log

          echo "=== GC_MACD_BB.py ===" | tee logs/30_GC_MACD_BB.log
          python GC_MACD_BB.py 2>&1 | tee -a logs/30_GC_MACD_BB.log

      # 成果物（CSVなど）
      - name: Upload metrics artifact (csv/charts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: atr-swing-metrics
          path: |
            reports/*.csv
            charts/*.png
          if-no-files-found: warn
          retention-days: 14

      # 実行ログ（今回ほしいやつ）
      - name: Upload run logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-logs
          path: |
            logs/*.log
          if-no-files-found: warn
          retention-days: 14
